# =======================================================================
# ğŸ”„ CI Pipeline - Automatische Build-PrÃ¼fung bei jedem Push
# =======================================================================
# PrÃ¼ft bei jedem Commit:
# 1. âœ… AbhÃ¤ngigkeiten installieren (npm install)
# 2. âœ… Linter ausfÃ¼hren (ESLint)
# 3. âœ… Smoke Test - Server startet ohne Crash
# =======================================================================

name: CI - Build & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./ai

    steps:
      # 1. Code auschecken
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      # 2. Node.js Setup
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: './ai/package-lock.json'

      # 3. AbhÃ¤ngigkeiten installieren
      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      # 4. ESLint ausfÃ¼hren
      - name: ğŸ” Run ESLint
        run: npm run lint
        continue-on-error: false

      # 5. Smoke Test - Server startet ohne Crash
      - name: ğŸš€ Smoke Test - Server Start
        run: |
          echo "ğŸ§ª Starting server smoke test..."
          
          # Starte Server im Hintergrund
          timeout 10s node server.js &
          SERVER_PID=$!
          
          # Warte kurz auf Start
          sleep 3
          
          # PrÃ¼fe ob Prozess noch lÃ¤uft
          if ps -p $SERVER_PID > /dev/null 2>&1; then
            echo "âœ… Server started successfully!"
            kill $SERVER_PID 2>/dev/null || true
            exit 0
          else
            echo "âŒ Server crashed on startup!"
            exit 1
          fi
        env:
          # Dummy-Werte fÃ¼r CI-Umgebung (Ollama nicht verfÃ¼gbar)
          CI: true

      # 6. Syntax-Check fÃ¼r alle JS-Dateien
      - name: ğŸ“ Syntax Check
        run: |
          echo "ğŸ” Checking JavaScript syntax..."
          for file in server.js src/*.js; do
            if [ -f "$file" ]; then
              node --check "$file" && echo "âœ… $file - OK" || exit 1
            fi
          done
          echo "âœ… All files passed syntax check!"
